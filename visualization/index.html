<!-- 
	Demo of Grafico

	The html is a static page for presenting couples of examples of graphs in Grafico. 
	Most of the visualization of graphs are supported by D3.js. And some other basic statistics
	are depended on other 3rd party opensource packages. 

	1. Force directed graph
	2. Map based graph
-->

<!-- HTML dom -->

<div id="map-svg"></div>
<div id="force-svg"></div>

<!-- JQuery -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<!-- Underscore -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<!-- D3.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.4/nv.d3.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.5/nv.d3.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<!-- Chart.js-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.bundle.min.js"></script>>
<!-- Customized css -->
<link rel="stylesheet" type="text/css" href="graph.css" media="screen" />

<!-- JS dependencies -->
<script src="graph.js"></script>

<!-- Hardcode dataset (in avoid of hosting a http server) -->
<script src="data/city_nodes.js"></script>
<script src="data/city_links.js"></script>
<script src="data/industry_nodes.js"></script>
<script src="data/industry_links.js"></script>
<script src="data/china_cities.js"></script>
<script src="data/china_provinces.js"></script>

<!-- Main function -->
<script type="text/javascript">
	var CITY_MIN_VALUE = 0,
		CITY_MAX_VALUE = _.max(city_links, function(link){ return link.value }).value;

	var cities = _.keys(city_nodes),
		_city_nodes = _.chain(city_nodes)
			.values()
			.map(function(node){
				node.group = _.indexOf(cities, node.city_name);
				return node; })
			.value(),
		_city_links = _.map(city_links, function(link){
				link.source = _.indexOf(cities, link.source);
				link.target = _.indexOf(cities, link.target);
				link.value = link.value > CITY_MIN_VALUE ? (link.value - CITY_MIN_VALUE) / CITY_MAX_VALUE : 0;
				return link; });

	var graph1 = {
		"nodes": _city_nodes,
		"links": _city_links
	};

	// var graph2 = JSON.parse(JSON.stringify( graph1 )); // deep copy
	// d3Graph.forceDirected("force-svg", graph1);

	locateEmptyCities(graph1);
	d3Graph.mapBased("map-svg", graph1);

	var INDUST_MIN_VALUE = 0,
		INDUST_MAX_VALUE = _.max(industry_links, function(link){ return link.value }).value;

	var industs_lv3 = _.keys(industry_nodes),
		industs_lv1 = _.chain(industry_nodes)
			.map(function(node){return node['industry_lv1']})
			.uniq()
			.value(),
		_industry_nodes = _.chain(industry_nodes)
			.values()
			.map(function(node){
				node.group = _.indexOf(industs_lv1, node.industry_lv1); 
				return node; })
			.value(),
		_industry_links = _.map(industry_links, function(link){
			link.source = _.indexOf(industs_lv3, link.source); 
			link.target = _.indexOf(industs_lv3, link.target); 
			link.value = link.value > INDUST_MIN_VALUE ? (link.value - INDUST_MIN_VALUE) / INDUST_MAX_VALUE : 0; 
			return link; });

		console.log(_industry_nodes.slice(1,5));
		console.log(_industry_links.slice(1,5));

	var graph2 = {
		"nodes": _industry_nodes,
		"links": _industry_links
	};

	d3Graph.forceDirected("force-svg", graph2);


</script>
